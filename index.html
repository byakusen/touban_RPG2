<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å½“ç•ªãƒ»å®¿é¡Œãƒã‚§ãƒƒã‚¯</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        /* åŸºæœ¬è¨­å®š */
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #333;
            overflow-y: overlay;
        }

        /* ã‚°ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ  */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        /* UIè¦ç´  */
        .tab-btn { transition: all 0.3s ease; opacity: 0.7; }
        .tab-btn.active { opacity: 1; background-color: rgba(255, 255, 255, 0.2); font-weight: 800; border-bottom: 3px solid #6366f1; }

        :root {
            --card-padding: 1.25rem;
            --name-size: 1.25rem; 
            --role-size: 0.75rem; 
            --icon-box-size: 9rem; 
            --icon-font-size: 5rem; 
            --btn-font: 1rem; 
            --btn-pad-y: 0.75rem;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .layout-normal { --card-padding: 0.85rem; --name-size: 1.125rem; --role-size: 0.7rem; --icon-box-size: 7rem; --icon-font-size: 4rem; --btn-font: 0.875rem; --btn-pad-y: 0.5rem; }
        .layout-compact { --card-padding: 0.65rem; --name-size: 1rem; --role-size: 0.65rem; --icon-box-size: 5rem; --icon-font-size: 2.5rem; --btn-font: 0.75rem; --btn-pad-y: 0.35rem; }
        .layout-tiny { --card-padding: 0.5rem; --name-size: 0.875rem; --role-size: 0.6rem; --icon-box-size: 3.5rem; --icon-font-size: 2rem; --btn-font: 0.7rem; --btn-pad-y: 0.25rem; }

        .card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: var(--card-padding); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15); }
        .card.absent { opacity: 0.7; background: rgba(240, 240, 240, 0.9); border: 2px dashed #ccc; }
        .card.absent .card-icon-box { filter: grayscale(100%); opacity: 0.5; }

        .card-icon-box { width: var(--icon-box-size); height: var(--icon-box-size); font-size: var(--icon-font-size); background-size: contain; background-repeat: no-repeat; background-position: center; }
        .card-btn { font-size: var(--btn-font); padding-top: var(--btn-pad-y); padding-bottom: var(--btn-pad-y); }

        .img-container { transition: all 0.3s ease; border: 4px solid transparent; }
        .img-container.completed { border-color: #22c55e; background-color: #f0fdf4; box-shadow: 0 0 15px rgba(34, 197, 94, 0.5); }
        .img-container.locked { background-color: #f3f4f6; color: #d1d5db; }
        .img-container.rare-effect { animation: sparkle 2s infinite alternate; border-color: #ffd700 !important; background-color: #fffbeb !important; box-shadow: 0 0 15px rgba(255, 215, 0, 0.6) !important; }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.3s ease-in-out; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .floating { animation: float 3s ease-in-out infinite; }
        @keyframes sparkle { 0% { filter: drop-shadow(0 0 2px gold) brightness(1); } 50% { filter: drop-shadow(0 0 8px gold) brightness(1.2); } 100% { filter: drop-shadow(0 0 2px gold) brightness(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content { animation: fadeIn 0.2s ease-out; }
        @keyframes bonusPop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        .bonus-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.95); padding: 2rem 3rem; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; z-index: 100; border: 4px solid #fbbf24; animation: bonusPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; pointer-events: none; }
        .warning-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.95); padding: 2rem 3rem; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; z-index: 100; border: 4px solid #ef4444; color: #dc2626; font-weight: bold; font-size: 1.5rem; animation: bonusPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; pointer-events: none; white-space: nowrap; }

        /* ãƒœã‚¹æ¼”å‡º */
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        .boss-damage { animation: shake 0.5s; filter: sepia(1) hue-rotate(-50deg) saturate(3); }
        @keyframes damageTextUp { 0% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, -30px); } }
        .damage-popup { position: absolute; top: 40%; left: 50%; transform: translateX(-50%); color: #ef4444; font-size: 2rem; font-weight: 900; text-shadow: 2px 2px 0px white; animation: damageTextUp 0.8s ease-out forwards; pointer-events: none; z-index: 50; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .settings-table th, .settings-table td { border: 1px solid #e5e7eb; }
        .settings-table input, .settings-table select { width: 100%; padding: 8px; background: transparent; outline: none; border-radius: 4px; }
        .settings-table input:focus, .settings-table select:focus { background-color: #f0f9ff; }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 0.8rem; position: relative; }
        .day-mark { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 1.2rem; line-height: 1; }

        /* ãã®ä»– */
        #teacherModeBar { background: repeating-linear-gradient(45deg, #fcd34d, #fcd34d 10px, #fbbf24 10px, #fbbf24 20px); }
        .stamp-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); width: 80%; height: 80%; background-image: url('https://github.com/byakusen/hanamaru/blob/main/hanamaru2.png?raw=true'); background-size: contain; background-repeat: no-repeat; background-position: center; opacity: 0.9; z-index: 10; pointer-events: none; animation: stampPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes stampPop { 0% { transform: translate(-50%, -50%) scale(2) rotate(0deg); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(1) rotate(-15deg); opacity: 0.9; } }

        /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            body { background: white; color: black; -webkit-print-color-adjust: exact; }
            .no-print, nav, footer, #bossArea, #teacherModeBar { display: none !important; }
            #view-settings { display: none !important; }
            #view-check { display: block !important; }
            #gridContainer { display: grid !important; grid-template-columns: repeat(5, 1fr) !important; gap: 10px !important; }
            .card { break-inside: avoid; border: 1px solid #ccc; box-shadow: none; padding: 5px; }
            .card-btn { display: none !important; }
            .img-container { border: none !important; width: 60px !important; height: 60px !important; }
            .card-icon-box { font-size: 2.5rem !important; }
            .card-name { font-size: 10px !important; }
        }

        * { -webkit-tap-highlight-color: transparent; }
        .hidden { display: none; }
    </style>
</head>
<body class="flex flex-col items-center py-2 px-2 md:px-4 relative">

    <!-- å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ä¸­ã®è¡¨ç¤ºãƒãƒ¼ -->
    <div id="teacherModeBar" class="w-full fixed top-0 left-0 z-50 flex justify-between items-center px-4 py-1 shadow-md hidden no-print">
        <span class="font-bold text-gray-800 text-sm">ğŸ‘¨â€ğŸ« å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ä¸­</span>
        <button onclick="exitTeacherMode()" class="bg-white text-xs px-2 py-1 rounded border border-gray-400 hover:bg-gray-100 font-bold">çµ‚äº†</button>
    </div>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav id="mainNav" class="w-full max-w-7xl flex justify-start mb-2 px-1 transition-all no-print">
        <div class="glass rounded-lg flex overflow-hidden scale-90 origin-left">
            <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn px-4 py-1.5 text-indigo-900 font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                åç°¿è¨­å®š <span class="text-xs ml-1 opacity-70">ğŸ”’</span>
            </button>
            <button onclick="switchTab('check')" id="tab-check" class="tab-btn active px-4 py-1.5 text-indigo-900 font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                ãƒã‚§ãƒƒã‚¯
            </button>
        </div>
    </nav>

    <!-- ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼: ãƒã‚§ãƒƒã‚¯ç”»é¢ -->
    <div id="view-check" class="w-full flex flex-col items-center flex-1 min-h-0">
        
        <!-- ãƒœã‚¹ãƒãƒˆãƒ« & ã‚¯ãƒ©ã‚¹åˆè¨ˆã‚¨ãƒªã‚¢ -->
        <div id="bossArea" class="w-full max-w-5xl mb-4 glass rounded-xl p-3 md:p-4 flex flex-col md:flex-row items-center justify-between gap-4 relative overflow-hidden transition-all bg-white/80">
            <div class="absolute inset-0 opacity-10 bg-gradient-to-r from-red-500 to-indigo-600 z-0 pointer-events-none"></div>
            
            <div class="z-10 flex flex-row md:flex-col items-center gap-4 md:gap-1 md:items-start text-indigo-900 flex-shrink-0">
                <div class="text-xs md:text-sm font-bold opacity-70">ã‚¯ãƒ©ã‚¹åˆè¨ˆãƒ¬ãƒ™ãƒ«</div>
                <div class="text-3xl md:text-4xl font-extrabold flex items-end gap-1">
                    <span id="displayClassLevel">0</span>
                    <span class="text-sm md:text-lg mb-1">Lv</span>
                </div>
                <div class="text-[10px] md:text-xs font-bold mt-0 md:mt-1 bg-white/60 px-2 py-1 rounded-full border border-indigo-100">
                    æ¬¡ã®ç›®æ¨™: <span id="nextClassLevelTarget">100</span>Lv
                </div>
            </div>

            <div class="z-10 flex-1 w-full px-2 flex flex-col items-center">
                <div class="flex items-center gap-2 mb-1 w-full justify-center">
                    <span class="text-[10px] font-bold bg-red-600 text-white px-2 py-0.5 rounded shadow-sm">BOSS</span>
                    <span id="bossName" class="font-bold text-gray-700 text-sm md:text-base truncate">å®¿é¡Œã‚¹ãƒ©ã‚¤ãƒ  Lv.1</span>
                    <button onclick="openBossBook()" class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-0.5 rounded border border-gray-400 no-print" title="è¨ä¼å›³é‘‘">ğŸ“–</button>
                </div>
                <div class="w-full h-5 md:h-6 bg-gray-200 rounded-full overflow-hidden shadow-inner relative border border-gray-300">
                    <div id="bossHpBar" class="h-full bg-gradient-to-r from-red-500 to-orange-500 transition-all duration-500" style="width: 100%"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-[10px] md:text-xs font-bold text-white drop-shadow-md">
                        HP: <span id="bossHpText">--/--</span>
                    </div>
                </div>
                <div class="text-[10px] text-gray-500 mt-1">ã¿ã‚“ãªã§ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚ˆã†ï¼</div>
            </div>

            <div class="z-10 relative flex-shrink-0">
                <img id="bossImage" src="" alt="Boss" class="w-20 h-20 md:w-24 md:h-24 object-contain filter drop-shadow-xl transition-transform cursor-pointer hover:scale-110">
            </div>
        </div>

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ -->
        <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-4 w-full max-w-5xl no-print">
            <h1 class="text-xl md:text-2xl font-extrabold text-white drop-shadow-md tracking-wider whitespace-nowrap">
                âœ¨ å½“ç•ªãƒ»å®¿é¡Œãƒã‚§ãƒƒã‚¯ âœ¨
            </h1>
            
            <div class="glass rounded-full px-4 py-1.5 flex items-center justify-between gap-4 shadow-lg scale-90 md:scale-100">
                <button onclick="changeDate(-1)" class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center hover:bg-indigo-700 transition shadow-md btn-check">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                </button>
                <div class="flex items-center gap-2 text-lg font-bold text-gray-800">
                    <span id="displayDate">--/--/--</span>
                    <button onclick="toggleAllAbsent()" id="btnAllAbsent" class="ml-2 text-xs px-3 py-1 rounded-full border border-gray-400 text-gray-500 hover:bg-gray-100 transition shadow-sm bg-white font-bold" title="ã“ã®æ—¥ã®å…¨å“¡ã‚’ä¼‘ã¿ã«ã—ã¾ã™">
                        ä¸€æ‹¬ä¼‘
                    </button>
                </div>
                <button onclick="changeDate(1)" class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center hover:bg-indigo-700 transition shadow-md btn-check">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                </button>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚°ãƒªãƒƒãƒ‰ (ç”Ÿå¾’ã‚«ãƒ¼ãƒ‰) -->
        <div id="gridContainer" class="w-full max-w-[95%] mb-12">
            <!-- JSã§å‹•çš„ã«ã‚¯ãƒ©ã‚¹ã¨ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ -->
        </div>
    </div>

    <!-- è¨­å®šãƒ“ãƒ¥ãƒ¼: åç°¿ç·¨é›†ç”»é¢ -->
    <div id="view-settings" class="w-full flex flex-col items-center hidden max-w-4xl pb-12">
        <header class="mb-6 text-center no-print">
            <h2 class="text-2xl font-bold text-white drop-shadow-md">ğŸ“‹ åç°¿ã¨ä¿‚ã®è¨­å®š</h2>
            <p class="text-white/90 text-sm mt-2">â€» ã“ã®ç”»é¢ã¯å…ˆç”Ÿã®ã¿ãŒæ“ä½œã§ãã¾ã™</p>
        </header>

        <!-- è¨­å®šã‚¨ãƒªã‚¢ï¼ˆä¸Šéƒ¨ï¼‰ -->
        <div class="glass w-full rounded-2xl p-4 md:p-6 mb-6 flex flex-col gap-4 no-print">
            <div>
                <h3 class="font-bold text-gray-800 border-b pb-2 mb-2">ğŸ‘¾ ãƒœã‚¹ãƒãƒˆãƒ«ã®è¨­å®š</h3>
                <div class="flex items-center gap-4">
                    <label class="text-sm font-bold text-gray-600">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼1ä½“ã®HP:</label>
                    <input type="number" id="bossHpInput" class="p-2 border rounded text-center w-24 bg-white" value="300" onchange="saveBossHp()">
                    <span class="text-xs text-gray-500">â€» å­¦ç´šäººæ•°ã«å¿œã˜ã¦èª¿æ•´ã—ã¦ãã ã•ã„ (æ¨å¥¨: äººæ•°Ã—10ç¨‹åº¦)</span>
                </div>
            </div>
            <div>
                <h3 class="font-bold text-gray-800 border-b pb-2 mb-2">ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š</h3>
                <div class="flex items-center gap-2">
                    <input type="text" id="newPasswordInput" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="p-2 border rounded text-center w-40 bg-white">
                    <button onclick="saveNewPassword()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 font-bold shadow-sm">å¤‰æ›´ã™ã‚‹</button>
                </div>
            </div>
             <div>
                <h3 class="font-bold text-gray-800 border-b pb-2 mb-2">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ»å°åˆ·</h3>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="printSheet()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-bold shadow-sm flex items-center gap-2">
                        ğŸ–¨ï¸ æ²ç¤ºç”¨ã«å°åˆ·
                    </button>
                    <button onclick="downloadBackup()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-bold shadow-sm flex items-center gap-2">
                        â¬‡ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜
                    </button>
                    <label class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 font-bold shadow-sm cursor-pointer flex items-center gap-2">
                        â¬†ï¸ å¾©å…ƒï¼ˆèª­ã¿è¾¼ã¿ï¼‰
                        <input type="file" accept=".json" class="hidden" onchange="loadBackup(this)">
                    </label>
                </div>
            </div>
        </div>

        <div class="glass w-full rounded-2xl p-4 md:p-8 overflow-hidden mb-8 no-print">
            <div class="overflow-x-auto max-h-[60vh]">
                <table class="settings-table w-full text-left border-collapse bg-white rounded-lg shadow-sm">
                    <thead class="sticky top-0 z-10">
                        <tr class="bg-indigo-100 text-indigo-900 shadow-sm">
                            <th class="p-3 w-16 text-center font-bold">é †åº</th>
                            <th class="p-3 w-12 text-center font-bold">No.</th>
                            <th class="p-3 font-bold w-1/3">åå‰ <span class="text-xs font-normal text-gray-500">(å¿…é ˆ)</span></th>
                            <th class="p-3 font-bold w-24">æ€§åˆ¥</th>
                            <th class="p-3 font-bold">ä¿‚ãƒ»å½“ç•ªå <span class="text-xs font-normal text-gray-500">(ä»»æ„)</span></th>
                        </tr>
                    </thead>
                    <tbody id="settingsTableBody">
                        <!-- JSã§ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="calendarModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm no-print" onclick="closeCalendarOutside(event)">
        <div class="modal-content glass bg-white/95 rounded-2xl w-[90%] max-w-lg p-6 relative shadow-2xl">
            <button onclick="closeCalendar()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div class="text-center mb-6">
                <h3 id="calStudentName" class="text-xl font-bold text-indigo-900 mb-2">--ã•ã‚“ã®è¨˜éŒ²</h3>
                <div class="flex items-center justify-center gap-4">
                    <button onclick="changeCalendarMonth(-1)" class="p-1 rounded-full hover:bg-gray-100 text-indigo-600">â—€</button>
                    <span id="calDateLabel" class="text-lg font-bold text-gray-700 min-w-[8rem]">--å¹´ --æœˆ</span>
                    <button onclick="changeCalendarMonth(1)" class="p-1 rounded-full hover:bg-gray-100 text-indigo-600">â–¶</button>
                </div>
            </div>
            <!-- å®Ÿç¸¾ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="achievementList" class="mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200 hidden">
                <h4 class="text-xs font-bold text-yellow-800 mb-2">ğŸ† ç²å¾—ã—ãŸç§°å·</h4>
                <div id="achievementIcons" class="flex flex-wrap gap-2 text-2xl justify-center"></div>
            </div>

            <div class="calendar-grid mb-2">
                <div class="text-center text-xs font-bold text-red-500">æ—¥</div>
                <div class="text-center text-xs font-bold text-gray-500">æœˆ</div>
                <div class="text-center text-xs font-bold text-gray-500">ç«</div>
                <div class="text-center text-xs font-bold text-gray-500">æ°´</div>
                <div class="text-center text-xs font-bold text-gray-500">æœ¨</div>
                <div class="text-center text-xs font-bold text-gray-500">é‡‘</div>
                <div class="text-center text-xs font-bold text-blue-500">åœŸ</div>
            </div>
            <div id="calGrid" class="calendar-grid"></div>
            <div class="mt-4 flex justify-center gap-4 text-xs text-gray-500">
                <div class="flex items-center gap-1"><img src="https://github.com/byakusen/hanamaru/blob/main/hanamaru2.png?raw=true" class="w-5 h-5 object-contain" alt="ã¯ãªã¾ã‚‹"> ä¸¡æ–¹OK</div>
                <div class="flex items-center gap-1"><span class="text-lg font-bold text-indigo-600">å½“</span> å½“ç•ªã®ã¿</div>
                <div class="flex items-center gap-1"><span class="text-lg font-bold text-amber-500">å®¿</span> å®¿é¡Œã®ã¿</div>
                <div class="flex items-center gap-1"><span class="text-sm font-bold text-gray-400">ä¼‘</span> æ¬ å¸­</div>
            </div>
        </div>
    </div>

    <!-- ãƒœã‚¹å›³é‘‘ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="bossBookModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm no-print" onclick="closeBossBookOutside(event)">
        <div class="modal-content glass bg-white/95 rounded-2xl w-[90%] max-w-3xl p-6 relative shadow-2xl max-h-[80vh] overflow-y-auto">
            <button onclick="closeBossBook()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 class="text-2xl font-bold text-indigo-900 mb-6 text-center border-b pb-2">ğŸ“– è¨ä¼å›³é‘‘</h3>
            <div id="bossBookGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- JSã§ç”Ÿæˆ -->
            </div>
             <div class="mt-8 text-center text-gray-500 text-sm">
                ã‚¯ãƒ©ã‚¹ã¿ã‚“ãªã§åŠ›ã‚’åˆã‚ã›ã¦ã€å…¨ã¦ã®ãƒœã‚¹ã‚’å€’ãã†ï¼
            </div>
        </div>
    </div>

    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="passwordModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm no-print" onclick="closePasswordModalOutside(event)">
        <div class="modal-content glass bg-white rounded-2xl p-6 shadow-2xl w-80 text-center">
            <h3 class="text-lg font-bold text-gray-800 mb-4">å…ˆç”Ÿãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›</h3>
            <!-- onkeydownã‚’è¿½åŠ  -->
            <input type="password" id="teacherPasswordInput" class="w-full p-2 border rounded mb-4 text-center text-xl tracking-widest" placeholder="****" onkeydown="if(event.key==='Enter') checkTeacherPassword()">
            <div class="flex justify-center gap-2">
                <button onclick="closePasswordModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="checkTeacherPassword()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-bold">OK</button>
            </div>
        </div>
    </div>

    <!-- ãƒœãƒ¼ãƒŠã‚¹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤ºç”¨ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="bonusContainer"></div>

    <!-- å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰èµ·å‹•ãƒœã‚¿ãƒ³ -->
    <button onclick="openPasswordModal()" class="fixed right-4 bottom-4 z-50 p-2 text-gray-500 bg-white/80 rounded-full shadow-lg hover:bg-white hover:text-indigo-600 transition backdrop-blur-sm no-print" title="å…ˆç”Ÿç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
        </svg>
    </button>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="mt-auto text-center text-white/70 text-xs py-2 flex flex-col items-center gap-1 relative w-full no-print">
        <button onclick="resetAllData()" class="underline hover:text-white transition">ãƒªã‚»ãƒƒãƒˆ</button>
    </footer>

    <!-- ãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
        // --- è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ ---
        const MAX_STUDENTS = 40;
        let teacherPassword = "1234"; 
        let bossHpPerLevel = 300;

        const LEVEL_THRESHOLDS = {
            1: 4, 2: 7, 3: 10, 4: 14, 5: 17, 6: 20, 7: 24, 8: 30,
            9: 37, 10: 44, 11: 50, 12: 57, 13: 64, 14: 74, 15: 87,
            16: 100, 17: 114, 18: 134
        };

        const BOSS_CONFIG = {
            bosses: [
                { name: "å®¿é¡Œã‚¹ãƒ©ã‚¤ãƒ ", icon: "https://github.com/byakusen/touban_monsutar/blob/main/1-01.png?raw=true" },
                { name: "å¿˜ã‚Œç‰©ã‚´ãƒ–ãƒªãƒ³", icon: "https://github.com/byakusen/touban_monsutar/blob/main/1-03.png?raw=true" },
                { name: "ãŠã—ã‚ƒã¹ã‚Šã‚¦ãƒ«ãƒ•", icon: "https://github.com/byakusen/touban_monsutar/blob/main/1-02.png?raw=true" },
                { name: "å±…çœ ã‚Šãƒ™ã‚¢", icon: "https://github.com/byakusen/touban_monsutar/blob/main/1-04.png?raw=true" },
                { name: "å¤œæ›´ã‹ã—ãƒãƒƒãƒˆ", icon: "https://github.com/byakusen/touban_monsutar/blob/main/1-05.png?raw=true" },
                { name: "å®¿é¡Œå¤§é­”ç‹", icon: "https://github.com/byakusen/touban_monsutar/blob/main/1-06.png?raw=true" },
                { name: "ä¼èª¬ã®ãƒ‰ãƒ©ã‚´ãƒ³", icon: "https://github.com/byakusen/touban_monsutar/blob/main/1-07.png?raw=true" }
            ]
        };

        const RPG_ASSETS = {
            rare: [
                "https://github.com/byakusen/reagazou/blob/main/20-1kamisama.png?raw=true",
                "https://github.com/byakusen/reagazou/blob/main/20-2kamisama.png?raw=true",
                "https://github.com/byakusen/reagazou/blob/main/20-3kamisama.png?raw=true",
                "https://github.com/byakusen/reagazou/blob/main/20-4kamisama.png?raw=true",
                "https://github.com/byakusen/reagazou/blob/main/20-5kamisama.png?raw=true",
                "https://github.com/byakusen/reagazou/blob/main/20-6kamisama.png?raw=true",
                "https://github.com/byakusen/reagazou/blob/main/20-7kamisama.png?raw=true",
                "https://github.com/byakusen/reagazou/blob/main/20-8kamisama.png?raw=true",
                "https://github.com/byakusen/reagazou/blob/main/20-9kamisama.png?raw=true",
                "https://github.com/byakusen/reagazou/blob/main/20-10kamisama.png?raw=true"
            ],
            boy: {
                1: ["https://raw.githubusercontent.com/byakusen/RPG_01-1/refs/heads/main/01akatyan.png"],
                2: ["https://raw.githubusercontent.com/byakusen/RPG_02-1/refs/heads/main/02youtien.png"],
                3: ["https://github.com/byakusen/RPG_03-1/blob/main/03shougakusei.png?raw=true"],
                4: ["https://github.com/byakusen/RPG_04-1/blob/main/04tyuugakusei.png?raw=true"],
                5: ["https://github.com/byakusen/RPG_05-1/blob/main/05-1farmer.png?raw=true", "https://github.com/byakusen/RPG_05-2/blob/main/05-2farmer.png?raw=true", "https://github.com/byakusen/RPG_05-3/blob/main/05-3farmer.png?raw=true", "https://github.com/byakusen/RPG_05-4/blob/main/05-4farmaer.png?raw=true", "https://github.com/byakusen/RPG_05-5/blob/main/05-5farmer.png?raw=true"],
                6: ["https://github.com/byakusen/RPG_06/blob/main/06-1shounin.png?raw=true", "https://github.com/byakusen/RPG_06/blob/main/06-2shounin.png?raw=true", "https://github.com/byakusen/RPG_06/blob/main/06-3shounin.png?raw=true", "https://github.com/byakusen/RPG_06/blob/main/06-4shounin.png?raw=true", "https://github.com/byakusen/RPG_06/blob/main/06-5shounin.png?raw=true"],
                7: ["https://github.com/byakusen/RPG_7/blob/main/07-1si-hu.png?raw=true", "https://github.com/byakusen/RPG_7/blob/main/07-2si-hu.png?raw=true", "https://github.com/byakusen/RPG_7/blob/main/07-3si-hu.png?raw=true", "https://github.com/byakusen/RPG_7/blob/main/07-4si-hu.png?raw=true", "https://github.com/byakusen/RPG_7/blob/main/07-5si-hu.png?raw=true"],
                8: ["https://github.com/byakusen/RPG_08/blob/main/08-1butouka.png?raw=true", "https://github.com/byakusen/RPG_08/blob/main/08-2butouka.png?raw=true", "https://github.com/byakusen/RPG_08/blob/main/08-3butouka.png?raw=true", "https://github.com/byakusen/RPG_08/blob/main/08-4butouka.png?raw=true", "https://github.com/byakusen/RPG_08/blob/main/08-5butouka.png?raw=true"],
                9: ["https://github.com/byakusen/RPG_09/blob/main/09-1sensi.png?raw=true", "https://github.com/byakusen/RPG_09/blob/main/09-2sensi.png?raw=true", "https://github.com/byakusen/RPG_09/blob/main/09-3sensi.png?raw=true", "https://github.com/byakusen/RPG_09/blob/main/09-4sensi.png?raw=true", "https://github.com/byakusen/RPG_09/blob/main/09-5sensi.png?raw=true"],
                10: ["https://github.com/byakusen/RPG_10/blob/main/10-1souryo.png?raw=true", "https://github.com/byakusen/RPG_10/blob/main/10-2souryo.png?raw=true", "https://github.com/byakusen/RPG_10/blob/main/10-3souryo.png?raw=true", "https://github.com/byakusen/RPG_10/blob/main/10-4souryo.png?raw=true", "https://github.com/byakusen/RPG_10/blob/main/10-5souryo.png?raw=true"],
                11: ["https://github.com/byakusen/RPG_11/blob/main/11-1yumitukai.png?raw=true", "https://github.com/byakusen/RPG_11/blob/main/11-2yumitukai.png?raw=true", "https://github.com/byakusen/RPG_11/blob/main/11-3yumitukai.png?raw=true", "https://github.com/byakusen/RPG_11/blob/main/11-4yumitukai.png?raw=true", "https://github.com/byakusen/RPG_11/blob/main/11-5yumitukai.png?raw=true"],
                12: ["https://github.com/byakusen/RPG_12/blob/main/12-1mahoutukai.png?raw=true", "https://github.com/byakusen/RPG_12/blob/main/12-2mahoutukai.png?raw=true", "https://github.com/byakusen/RPG_12/blob/main/12-3mahoutukai.png?raw=true", "https://github.com/byakusen/RPG_12/blob/main/12-4mahoutukai.png?raw=true", "https://github.com/byakusen/RPG_12/blob/main/12-5mahoutukai.png?raw=true"],
                13: ["https://github.com/byakusen/RPG_13/blob/main/13-1kisi.png?raw=true", "https://github.com/byakusen/RPG_13/blob/main/13-2kisi.png?raw=true", "https://github.com/byakusen/RPG_13/blob/main/13-3kisi.png?raw=true", "https://github.com/byakusen/RPG_13/blob/main/13-4kisi.png?raw=true", "https://github.com/byakusen/RPG_13/blob/main/13-5kisi.png?raw=true"],
                14: ["https://github.com/byakusen/RPG_14/blob/main/14-1ninja.png?raw=true", "https://github.com/byakusen/RPG_14/blob/main/14-2ninja.png?raw=true", "https://github.com/byakusen/RPG_14/blob/main/14-3ninja.png?raw=true", "https://github.com/byakusen/RPG_14/blob/main/14-4ninja.png?raw=true", "https://github.com/byakusen/RPG_14/blob/main/14-5ninja.png?raw=true"],
                15: ["https://github.com/byakusen/RPG_15/blob/main/15-1samurai.png?raw=true", "https://github.com/byakusen/RPG_15/blob/main/15-2samurai.png?raw=true", "https://github.com/byakusen/RPG_15/blob/main/15-3samurai.png?raw=true", "https://github.com/byakusen/RPG_15/blob/main/15-4samurai.png?raw=true", "https://github.com/byakusen/RPG_15/blob/main/15-5samurai.png?raw=true"],
                16: ["https://github.com/byakusen/RPG_16/blob/main/16-1kenja.png?raw=true", "https://github.com/byakusen/RPG_16/blob/main/16-2kenja.png?raw=true", "https://github.com/byakusen/RPG_16/blob/main/16-3kenja.png?raw=true", "https://github.com/byakusen/RPG_16/blob/main/16-4kenja.png?raw=true", "https://github.com/byakusen/RPG_16/blob/main/16-5kenja.png?raw=true"],
                17: ["https://github.com/byakusen/RPG_17/blob/main/17-1yuusha.png?raw=true", "https://github.com/byakusen/RPG_17/blob/main/17-2yuusha.png?raw=true", "https://github.com/byakusen/RPG_17/blob/main/17-3yuusha.png?raw=true", "https://github.com/byakusen/RPG_17/blob/main/17-4yuusha.png?raw=true", "https://github.com/byakusen/RPG_17/blob/main/17-5yuusha.png?raw=true"],
                18: ["https://github.com/byakusen/RPG_18/blob/main/18-1ouji.png?raw=true", "https://github.com/byakusen/RPG_18/blob/main/18-2ouji.png?raw=true", "https://github.com/byakusen/RPG_18/blob/main/18-3ouji.png?raw=true", "https://github.com/byakusen/RPG_18/blob/main/18-4ouji.png?raw=true", "https://github.com/byakusen/RPG_18/blob/main/18-5ouji.png?raw=true"]
            },
            girl: {
                1: ["https://raw.githubusercontent.com/byakusen/RPG_01-1/refs/heads/main/01akatyan.png"],
                2: ["https://raw.githubusercontent.com/byakusen/RPG_02-1/refs/heads/main/02youtien.png"],
                3: ["https://github.com/byakusen/RPG_03-1/blob/main/03shougakusei.png?raw=true"],
                4: ["https://github.com/byakusen/RPG_04-1/blob/main/04tyuugakusei.png?raw=true"],
                5: ["https://github.com/byakusen/RPG_05-6/blob/main/05-6farmer.png?raw=true", "https://github.com/byakusen/RPG_05-7/blob/main/05-7farmer.png?raw=true", "https://github.com/byakusen/RPG_05-8/blob/main/05-8farmer.png?raw=true", "https://github.com/byakusen/RPG_05-9/blob/main/05-9farmer.png?raw=true", "https://github.com/byakusen/RPG_05-10/blob/main/05-10farmer.png?raw=true"],
                6: ["https://github.com/byakusen/RPG_06/blob/main/06-6shounin.png?raw=true", "https://github.com/byakusen/RPG_06/blob/main/06-7shounin.png?raw=true", "https://github.com/byakusen/RPG_06/blob/main/06-8shounin.png?raw=true", "https://github.com/byakusen/RPG_06/blob/main/06-9shounin.png?raw=true", "https://github.com/byakusen/RPG_06/blob/main/06-10shounin.png?raw=true"],
                7: ["https://github.com/byakusen/RPG_7/blob/main/07-6si-hu.png?raw=true", "https://github.com/byakusen/RPG_7/blob/main/07-7si-hu.png?raw=true", "https://github.com/byakusen/RPG_7/blob/main/07-8si-hu.png?raw=true", "https://github.com/byakusen/RPG_7/blob/main/07-9si-hu.png?raw=true", "https://github.com/byakusen/RPG_7/blob/main/07-10si-hu.png?raw=true"],
                8: ["https://github.com/byakusen/RPG_08/blob/main/08-6butouka.png?raw=true", "https://github.com/byakusen/RPG_08/blob/main/08-7butouka.png?raw=true", "https://github.com/byakusen/RPG_08/blob/main/08-8butouka.png?raw=true", "https://github.com/byakusen/RPG_08/blob/main/08-9butouka.png?raw=true", "https://github.com/byakusen/RPG_08/blob/main/08-10butouka.png?raw=true"],
                9: ["https://github.com/byakusen/RPG_09/blob/main/09-6sensi.png?raw=true", "https://github.com/byakusen/RPG_09/blob/main/09-7sensi.png?raw=true", "https://github.com/byakusen/RPG_09/blob/main/09-8sensi.png?raw=true", "https://github.com/byakusen/RPG_09/blob/main/09-9sensi.png?raw=true", "https://github.com/byakusen/RPG_09/blob/main/09-10sensi.png?raw=true"],
                10: ["https://github.com/byakusen/RPG_10/blob/main/10-6souryo.png?raw=true", "https://github.com/byakusen/RPG_10/blob/main/10-7souryo.png?raw=true", "https://github.com/byakusen/RPG_10/blob/main/10-8souryo.png?raw=true", "https://github.com/byakusen/RPG_10/blob/main/10-9souryo.png?raw=true", "https://github.com/byakusen/RPG_10/blob/main/10-10souryo.png?raw=true"],
                11: ["https://github.com/byakusen/RPG_11/blob/main/11-6yumitukai.png?raw=true", "https://github.com/byakusen/RPG_11/blob/main/11-7yumitukai.png?raw=true", "https://github.com/byakusen/RPG_11/blob/main/11-8yumitukai.png?raw=true", "https://github.com/byakusen/RPG_11/blob/main/11-9yumitukai.png?raw=true", "https://github.com/byakusen/RPG_11/blob/main/11-10yumitukai.png?raw=true"],
                12: ["https://github.com/byakusen/RPG_12/blob/main/12-6mahoutukai.png?raw=true", "https://github.com/byakusen/RPG_12/blob/main/12-7mahoutukai.png?raw=true", "https://github.com/byakusen/RPG_12/blob/main/12-8mahoutukai.png?raw=true", "https://github.com/byakusen/RPG_12/blob/main/12-9mahoutukai.png?raw=true", "https://github.com/byakusen/RPG_12/blob/main/12-10mahoutukai.png?raw=true"],
                13: ["https://github.com/byakusen/RPG_13/blob/main/13-6kisi.png?raw=true", "https://github.com/byakusen/RPG_13/blob/main/13-7kisi.png?raw=true", "https://github.com/byakusen/RPG_13/blob/main/13-8kisi.png?raw=true", "https://github.com/byakusen/RPG_13/blob/main/13-9kisi.png?raw=true", "https://github.com/byakusen/RPG_13/blob/main/13-10kisi.png?raw=true"],
                14: ["https://github.com/byakusen/RPG_14/blob/main/14-6ninja.png?raw=true", "https://github.com/byakusen/RPG_14/blob/main/14-7ninja.png?raw=true", "https://github.com/byakusen/RPG_14/blob/main/14-8ninja.png?raw=true", "https://github.com/byakusen/RPG_14/blob/main/14-9ninja.png?raw=true", "https://github.com/byakusen/RPG_14/blob/main/14-10ninja.png?raw=true"],
                15: ["https://github.com/byakusen/RPG_15/blob/main/15-6samurai.png?raw=true", "https://github.com/byakusen/RPG_15/blob/main/15-7samurai.png?raw=true", "https://github.com/byakusen/RPG_15/blob/main/15-8samurai.png?raw=true", "https://github.com/byakusen/RPG_15/blob/main/15-9samurai.png?raw=true", "https://github.com/byakusen/RPG_15/blob/main/15-10samurai.png?raw=true"],
                16: ["https://github.com/byakusen/RPG_16/blob/main/16-6kenja.png?raw=true", "https://github.com/byakusen/RPG_16/blob/main/16-7kenja.png?raw=true", "https://github.com/byakusen/RPG_16/blob/main/16-8kenja.png?raw=true", "https://github.com/byakusen/RPG_16/blob/main/16-9kenja.png?raw=true", "https://github.com/byakusen/RPG_16/blob/main/16-10kenja.png?raw=true"],
                17: ["https://github.com/byakusen/RPG_17/blob/main/17-6yuusha.png?raw=true", "https://github.com/byakusen/RPG_17/blob/main/17-7yuusha.png?raw=true", "https://github.com/byakusen/RPG_17/blob/main/17-8yuusha.png?raw=true", "https://github.com/byakusen/RPG_17/blob/main/17-9yuusha.png?raw=true", "https://github.com/byakusen/RPG_17/blob/main/17-10yuusha.png?raw=true"],
                18: ["https://github.com/byakusen/RPG_18/blob/main/18-6oujo.png?raw=true", "https://github.com/byakusen/RPG_18/blob/main/18-7oujo.png?raw=true", "https://github.com/byakusen/RPG_18/blob/main/18-8oujo.png?raw=true", "https://github.com/byakusen/RPG_18/blob/main/18-9oujo.png?raw=true", "https://github.com/byakusen/RPG_18/blob/main/18-10oujo.png?raw=true"]
            }
        };

        // ç§°å·è¨­å®š
        const ACHIEVEMENT_CONFIG = [
            { id: '3day_streak', name: 'ä¸‰æ—¥æœˆã®èª“ã„', desc: '3æ—¥é€£ç¶šé”æˆï¼', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-01.png?raw=true', condition: { type: 'streak', val: 3 } },
            { id: 'week_streak', name: 'ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒ»ãƒ’ãƒ¼ãƒ­ãƒ¼', desc: '1é€±é–“é€£ç¶šé”æˆï¼', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-02.png?raw=true', condition: { type: 'streak', val: 7 } },
            { id: 'month_streak', name: 'ä¸å±ˆã®ã‚¢ã‚¤ã‚¢ãƒ³ãƒãƒ³', desc: '1ãƒ¶æœˆé€£ç¶šé”æˆï¼', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-03.png?raw=true', condition: { type: 'streak', val: 30 } },
            { id: 'perfect_term', name: 'ä¼èª¬ã®çš†å‹¤è³', desc: 'å­¦æœŸã‚’é€šã—ã¦ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-04.png?raw=true', condition: { type: 'streak', val: 100 } },
            { id: 'pt_50', name: 'ãƒ–ãƒ­ãƒ³ã‚ºãƒ»ãƒãƒƒã‚¸', desc: 'ç´¯è¨ˆ 50ãƒã‚¤ãƒ³ãƒˆ', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-05.png?raw=true', condition: { type: 'totalPt', val: 50 } },
            { id: 'pt_150', name: 'ã‚·ãƒ«ãƒãƒ¼ãƒ»ãƒãƒƒã‚¸', desc: 'ç´¯è¨ˆ 150ãƒã‚¤ãƒ³ãƒˆ', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-06.png?raw=true', condition: { type: 'totalPt', val: 150 } },
            { id: 'pt_300', name: 'ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ»ãƒãƒƒã‚¸', desc: 'ç´¯è¨ˆ 300ãƒã‚¤ãƒ³ãƒˆ', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-07.png?raw=true', condition: { type: 'totalPt', val: 300 } },
            { id: 'pt_500', name: 'ãƒ—ãƒ©ãƒãƒŠãƒ»ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰', desc: 'ç´¯è¨ˆ 500ãƒã‚¤ãƒ³ãƒˆ', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-08.png?raw=true', condition: { type: 'totalPt', val: 500 } },
            { id: 'homework_master', name: 'å®¿é¡Œãƒã‚¹ã‚¿ãƒ¼', desc: 'å®¿é¡Œæå‡ºç‡ãŒé«˜ã„ï¼', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-16.png?raw=true', condition: { type: 'manual' } },
            { id: 'job_leader', name: 'ãŠä»•äº‹ãƒªãƒ¼ãƒ€ãƒ¼', desc: 'å½“ç•ªæ´»å‹•ç‡ãŒé«˜ã„ï¼', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-10.png?raw=true', condition: { type: 'manual' } },
            { id: 'dual_wielder', name: 'äºŒåˆ€æµã®é”äºº', desc: 'å®¿é¡Œã¨å½“ç•ªã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„ï¼', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-11.png?raw=true', condition: { type: 'manual' } },
            { id: 'lucky7', name: 'ãƒ©ãƒƒã‚­ãƒ¼ã‚»ãƒ–ãƒ³', desc: 'ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆãŒ77', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-12.png?raw=true', condition: { type: 'currentPt', val: 77 } },
            { id: 'kiriban', name: 'ã‚­ãƒªç•ªã‚²ãƒƒã‚¿ãƒ¼', desc: 'ç´¯è¨ˆãƒã‚¤ãƒ³ãƒˆãŒã‚­ãƒªã®è‰¯ã„æ•°å­—', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-13.png?raw=true', condition: { type: 'modPt', val: 100 } },
            { id: 'phoenix', name: 'å¾©æ´»ã®ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹', desc: 'ä¹…ã—ã¶ã‚Šã«å¾©å¸°ï¼', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-14.png?raw=true', condition: { type: 'manual' } },
            { id: 'guardian', name: 'ã‚¯ãƒ©ã‚¹ã®å®ˆè­·ç¥', desc: 'ãƒœã‚¹ã«ã¨ã©ã‚ã‚’åˆºã—ãŸï¼', icon: 'https://github.com/byakusen/touban_tokuten/blob/main/1-15.png?raw=true', condition: { type: 'manual' } }
        ];

        // çŠ¶æ…‹ç®¡ç†
        let currentDate = new Date();
        let activityData = {};
        let studentList = [];
        let classGameData = { defeatedBosses: [] }; // è¿½åŠ : ã‚²ãƒ¼ãƒ å…¨ä½“ãƒ‡ãƒ¼ã‚¿
        let isTeacherMode = false;
        let pendingTab = null;

        let calendarYear = new Date().getFullYear();
        let calendarMonth = new Date().getMonth();
        let currentCalendarStudentId = null;

        // --- åˆæœŸåŒ– ---
        window.onload = () => {
            loadAllData();
            initSettingsTable();
            renderCheckView();
        };

        // --- ãƒ‡ãƒ¼ã‚¿æ“ä½œ ---
        function loadAllData() {
            const storedPass = localStorage.getItem('classTeacherPassword');
            if (storedPass) teacherPassword = storedPass;
            
            const storedHp = localStorage.getItem('classBossHpPerLevel');
            if (storedHp) bossHpPerLevel = parseInt(storedHp, 10);
            document.getElementById('bossHpInput').value = bossHpPerLevel;

            const actStored = localStorage.getItem('classActivityData');
            if (actStored) activityData = JSON.parse(actStored);

            const listStored = localStorage.getItem('classStudentList');
            if (listStored) {
                studentList = JSON.parse(listStored);
                let needsSave = false;
                studentList.forEach(s => {
                    if (s.iconSeed === undefined) { s.iconSeed = s.id; needsSave = true; }
                    if (s.lastSeededDate === undefined) { s.lastSeededDate = ""; needsSave = true; }
                    if (s.gender === undefined) { s.gender = 'boy'; needsSave = true; }
                    if (s.achievements === undefined) { s.achievements = []; needsSave = true; } // è¿½åŠ 
                });
                if (needsSave) saveStudentList();
            } else {
                studentList = Array.from({ length: MAX_STUDENTS }, (_, i) => ({
                    id: i + 1,
                    name: i < 3 ? `å…ç«¥${String.fromCharCode(65 + i)}` : "", 
                    role: i < 3 ? "ä¿‚" : "",
                    gender: 'boy',
                    iconSeed: i + 1,
                    lastSeededDate: "",
                    achievements: [] // è¿½åŠ 
                }));
                saveStudentList();
            }

            const gameStored = localStorage.getItem('classGameData'); // è¿½åŠ 
            if (gameStored) classGameData = JSON.parse(gameStored);
        }

        function saveActivityData() {
            localStorage.setItem('classActivityData', JSON.stringify(activityData));
        }

        function saveStudentList() {
            localStorage.setItem('classStudentList', JSON.stringify(studentList));
        }
        
        function saveGameData() { // è¿½åŠ 
            localStorage.setItem('classGameData', JSON.stringify(classGameData));
        }

        function saveNewPassword() {
            const input = document.getElementById('newPasswordInput');
            const newPass = input.value;
            if (newPass && newPass.length > 0) {
                teacherPassword = newPass;
                localStorage.setItem('classTeacherPassword', newPass);
                alert(`ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ: ${newPass}`);
                input.value = "";
            } else {
                showWarningEffect("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            }
        }
        
        function saveBossHp() {
            const input = document.getElementById('bossHpInput');
            const val = parseInt(input.value, 10);
            if (!isNaN(val) && val > 0) {
                bossHpPerLevel = val;
                localStorage.setItem('classBossHpPerLevel', val);
                renderCheckView();
            }
        }
        
        // è¿½åŠ : ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©å…ƒ
        function downloadBackup() {
            const backupData = {
                activityData,
                studentList,
                classGameData,
                bossHpPerLevel,
                version: 1
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "class_activity_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function loadBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.activityData && data.studentList) {
                        if(confirm("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) {
                            activityData = data.activityData;
                            studentList = data.studentList;
                            if (data.classGameData) classGameData = data.classGameData;
                            if (data.bossHpPerLevel) {
                                bossHpPerLevel = data.bossHpPerLevel;
                                localStorage.setItem('classBossHpPerLevel', bossHpPerLevel);
                            }
                            saveActivityData();
                            saveStudentList();
                            saveGameData();
                            location.reload();
                        }
                    } else {
                        alert("ç„¡åŠ¹ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚");
                    }
                } catch (error) {
                    alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                }
            };
            reader.readAsText(file);
        }

        function printSheet() {
            window.print();
        }

        function getDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        // --- ãƒ­ã‚¸ãƒƒã‚¯ ---
        function calculateLevel(points) {
            const levels = Object.keys(LEVEL_THRESHOLDS).map(Number).sort((a, b) => b - a);
            for (let lvl of levels) {
                if (points >= LEVEL_THRESHOLDS[lvl]) return lvl;
            }
            return 0; 
        }

        function getClassStats() {
            let totalClassPoints = 0;
            let totalClassLevel = 0;
            const activeStudentIds = studentList.filter(s => s.name && s.name.trim() !== "").map(s => s.id);
            
            activeStudentIds.forEach(id => {
                const student = studentList.find(s => s.id === id);
                if (student) {
                    const stats = getStudentStats(student);
                    totalClassPoints += stats.totalPoints;
                    totalClassLevel += stats.level;
                }
            });
            
            const sortedDates = Object.keys(activityData).sort();
            const activeStudentCount = activeStudentIds.length;
            
            sortedDates.forEach(dateKey => {
                let isPerfect = false;
                if (activeStudentCount > 0) {
                    isPerfect = activeStudentIds.every(id => {
                        const d = activityData[dateKey]?.[id];
                        if (d && d.absent) return true; 
                        return d && d.toban && d.shukudai;
                    });
                }
                if (isPerfect && activeStudentCount > 0) {
                    totalClassPoints += activeStudentCount;
                }
            });

            return { totalClassPoints, totalClassLevel };
        }

        function getStudentStats(student) {
            let totalPoints = 0;
            const sortedDates = Object.keys(activityData).sort();
            let currentStreak = 0;

            sortedDates.forEach(dateKey => {
                const dayRecord = activityData[dateKey][student.id];
                if (!dayRecord) return; 

                if (dayRecord.toban) totalPoints += 1;
                if (dayRecord.shukudai) totalPoints += 1;

                if (dayRecord.absent) {
                    // skip
                } else if (dayRecord.toban && dayRecord.shukudai) {
                    currentStreak++;
                    if (currentStreak % 7 === 0) {
                        totalPoints += 2; 
                        currentStreak = 0; 
                    }
                } else {
                    currentStreak = 0;
                }
            });

            const level = calculateLevel(totalPoints);
            let selectedIcon = "";
            let bgClass = "bg-gray-100"; 
            let isRare = false;

            if (level > 0) {
                const gender = student.gender || 'boy';
                let assets = RPG_ASSETS[gender][level] || RPG_ASSETS[gender][1];
                
                const dateKey = getDateKey(currentDate);
                const activeStudents = studentList.filter(s => s.name && s.name.trim() !== "");
                let isClassPerfect = false;
                
                if (activeStudents.length > 0) {
                    isClassPerfect = activeStudents.every(s => {
                        const d = activityData[dateKey]?.[s.id];
                        if (d && d.absent) return true;
                        return d && d.toban && d.shukudai;
                    });
                }

                if (isClassPerfect) {
                    assets = RPG_ASSETS.rare;
                    isRare = true;
                }
                
                const iconCount = assets.length;
                const seed = student.iconSeed || student.id;
                const iconIndex = seed % iconCount;
                selectedIcon = assets[iconIndex];

                const colors = ["bg-green-100", "bg-blue-100", "bg-yellow-100", "bg-red-100", "bg-purple-100"];
                const colorIndex = (level - 1) % colors.length;
                bgClass = colors[colorIndex];
                
                if (isRare) {
                    bgClass += " rare-effect";
                }
            } else {
                selectedIcon = ""; 
                bgClass = "locked";
            }

            return { totalPoints, level, icon: selectedIcon, bg: bgClass };
        }

        // --- ç§°å·åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (è¿½åŠ ) ---
        function checkAchievements(studentId) {
            const student = studentList.find(s => s.id === studentId);
            if (!student) return;
            if (!student.achievements) student.achievements = [];

            const stats = getStudentStats(student); // totalPointsè¨ˆç®—æ¸ˆã¿
            const currentPt = stats.totalPoints;
            
            // Streakè¨ˆç®—
            const sortedDates = Object.keys(activityData).sort();
            let streak = 0;
            let maxStreak = 0;
            sortedDates.forEach(dateKey => {
                const d = activityData[dateKey][studentId];
                if (d && !d.absent) {
                    if (d.toban && d.shukudai) {
                        streak++;
                        if (streak > maxStreak) maxStreak = streak;
                    } else {
                        streak = 0;
                    }
                }
            });

            // æ¡ä»¶ãƒã‚§ãƒƒã‚¯
            let newAchievement = null;
            ACHIEVEMENT_CONFIG.forEach(ach => {
                // æ—¢ã«æŒã£ã¦ã„ãŸã‚‰ã‚¹ã‚­ãƒƒãƒ—
                if (student.achievements.includes(ach.id)) return;

                let attained = false;
                if (ach.condition.type === 'streak' && maxStreak >= ach.condition.val) attained = true;
                if (ach.condition.type === 'totalPt' && currentPt >= ach.condition.val) attained = true;
                if (ach.condition.type === 'currentPt' && currentPt === ach.condition.val) attained = true;
                if (ach.condition.type === 'modPt' && currentPt > 0 && currentPt % ach.condition.val === 0) attained = true;
                
                if (attained) {
                    student.achievements.push(ach.id);
                    newAchievement = ach;
                }
            });

            if (newAchievement) {
                saveStudentList();
                showBonusEffect(`ğŸ† ç§°å·ç²å¾—ï¼ã€Œ${newAchievement.name}ã€`);
                playSound('correct');
            }
        }

        // --- ä¸¦ã³æ›¿ãˆæ©Ÿèƒ½ (è¿½åŠ ) ---
        function moveStudent(index, direction) {
            if (direction === -1 && index > 0) {
                [studentList[index], studentList[index - 1]] = [studentList[index - 1], studentList[index]];
            } else if (direction === 1 && index < studentList.length - 1) {
                [studentList[index], studentList[index + 1]] = [studentList[index + 1], studentList[index]];
            }
            saveStudentList();
            initSettingsTable(); // å†æç”»
        }

        // --- UIåˆ‡ã‚Šæ›¿ãˆ ---
        function switchTab(tabName, force = false) {
            if (tabName === 'settings' && !isTeacherMode && !force) {
                pendingTab = 'settings';
                openPasswordModal();
                return;
            }

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'check') {
                document.getElementById('view-check').classList.remove('hidden');
                document.getElementById('view-settings').classList.add('hidden');
                renderCheckView();
            } else {
                document.getElementById('view-check').classList.add('hidden');
                document.getElementById('view-settings').classList.remove('hidden');
            }
        }

        // --- è¨­å®šç”»é¢ ---
        function initSettingsTable() {
            const tbody = document.getElementById('settingsTableBody');
            tbody.innerHTML = '';

            for (let i = 0; i < MAX_STUDENTS; i++) {
                // å®‰å…¨ç­–
                if (!studentList[i]) studentList[i] = { id: i + 1, name: "", role: "", gender: "boy", iconSeed: i + 1, lastSeededDate: "", achievements: [] };
                const student = studentList[i];

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center">
                        <button onclick="moveStudent(${i}, -1)" class="text-gray-500 hover:text-blue-600">â¬†</button>
                        <button onclick="moveStudent(${i}, 1)" class="text-gray-500 hover:text-blue-600">â¬‡</button>
                    </td>
                    <td class="text-center font-bold text-gray-500 bg-gray-50">${student.id}</td>
                    <td>
                        <input type="text" placeholder="åå‰ã‚’å…¥åŠ›" value="${student.name}" 
                               onchange="updateStudent(${i}, 'name', this.value)">
                    </td>
                    <td>
                        <select onchange="updateStudent(${i}, 'gender', this.value)" class="cursor-pointer">
                            <option value="boy" ${student.gender === 'boy' ? 'selected' : ''}>ç”·å­ ğŸ‘¦</option>
                            <option value="girl" ${student.gender === 'girl' ? 'selected' : ''}>å¥³å­ ğŸ‘§</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" placeholder="ä¿‚å" value="${student.role || ''}" 
                               onchange="updateStudent(${i}, 'role', this.value)">
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }

        function updateStudent(index, field, value) {
            studentList[index][field] = value;
            saveStudentList();
        }

        // --- ãƒã‚§ãƒƒã‚¯ç”»é¢æ“ä½œ ---
        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            renderCheckView();
        }

        function toggleAbsent(studentId) {
            const dateKey = getDateKey(currentDate);
            if (!activityData[dateKey]) activityData[dateKey] = {};
            if (!activityData[dateKey][studentId]) activityData[dateKey][studentId] = { toban: false, shukudai: false, absent: false };

            const currentVal = activityData[dateKey][studentId].absent;
            activityData[dateKey][studentId].absent = !currentVal;
            if (!currentVal) {
                activityData[dateKey][studentId].toban = false;
                activityData[dateKey][studentId].shukudai = false;
            }
            saveActivityData();
            renderCheckView();
        }

        function toggleAllAbsent() {
            const dateKey = getDateKey(currentDate);
            if (!activityData[dateKey]) activityData[dateKey] = {};
            const activeStudents = studentList.filter(s => s.name && s.name.trim() !== "");
            const isAllAbsent = activeStudents.every(student => activityData[dateKey]?.[student.id]?.absent === true);
            const newAbsentState = !isAllAbsent; 

            activeStudents.forEach(student => {
                if (!activityData[dateKey][student.id]) {
                    activityData[dateKey][student.id] = { toban: false, shukudai: false, absent: false };
                }
                activityData[dateKey][student.id].absent = newAbsentState;
                if (newAbsentState) {
                    activityData[dateKey][student.id].toban = false;
                    activityData[dateKey][student.id].shukudai = false;
                }
            });
            saveActivityData();
            renderCheckView();
        }

        function toggleTask(studentId, taskType) {
            const dateKey = getDateKey(currentDate);
            if (!activityData[dateKey]) activityData[dateKey] = {};
            if (!activityData[dateKey][studentId]) activityData[dateKey][studentId] = { toban: false, shukudai: false, absent: false };

            if (activityData[dateKey][studentId].absent) {
                showWarningEffect("æ¬ å¸­æ‰±ã„ã§ã™ã€‚ã€Œä¼‘ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è§£é™¤ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const currentVal = activityData[dateKey][studentId][taskType];
            activityData[dateKey][studentId][taskType] = !currentVal;

            if (!currentVal) {
                playSound('correct');
                const newData = activityData[dateKey][studentId];
                
                // ãƒœã‚¹ãƒ€ãƒ¡ãƒ¼ã‚¸
                const prevStats = getClassStats();
                const prevDamage = prevStats.totalClassPoints % bossHpPerLevel;
                const bossMaxHp = bossHpPerLevel;
                
                // ãƒ€ãƒ¡ãƒ¼ã‚¸æ¼”å‡º
                const bossImage = document.getElementById('bossImage');
                if(bossImage) {
                    bossImage.classList.remove('boss-damage');
                    void bossImage.offsetWidth; 
                    bossImage.classList.add('boss-damage');
                    const container = document.getElementById('bossArea');
                    const dmg = document.createElement('div');
                    dmg.className = 'damage-popup';
                    dmg.innerText = "-1";
                    dmg.style.left = (50 + (Math.random()*20 - 10)) + "%";
                    container.appendChild(dmg);
                    setTimeout(() => dmg.remove(), 1000);
                }

                if (newData.toban && newData.shukudai) {
                     triggerConfetti();
                     
                     // å€‹äººç”»åƒæŠ½é¸
                     const studentIndex = studentList.findIndex(s => s.id === studentId);
                     if (studentIndex !== -1) {
                         const student = studentList[studentIndex];
                         if (student.lastSeededDate !== dateKey) {
                             student.iconSeed = Math.floor(Math.random() * 10000);
                             student.lastSeededDate = dateKey; 
                             saveStudentList();
                         }
                     }
                     
                     // ã‚¯ãƒ©ã‚¹ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹
                     const activeStudents = studentList.filter(s => s.name && s.name.trim() !== "");
                     const isClassPerfect = activeStudents.every(s => {
                        const d = activityData[dateKey]?.[s.id];
                        if (d && d.absent) return true;
                        return d && d.toban && d.shukudai;
                     });
                     
                     if (isClassPerfect) {
                         showBonusEffect(`ğŸ‰ å…¨å“¡é”æˆï¼ è¿½åŠ ãƒ€ãƒ¡ãƒ¼ã‚¸ ${activeStudents.length}pt!! ğŸ‰`);
                     }

                     checkBonusEffect(studentId);
                     checkAchievements(studentId); // ç§°å·ãƒã‚§ãƒƒã‚¯
                }

                // ãƒœã‚¹è¨ä¼åˆ¤å®š (ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—å¾Œã®HPã‚’è¦‹ã‚‹)
                // getClassStatsã¯ç¾åœ¨ã®Dataã‚’å…ƒã«è¨ˆç®—ã™ã‚‹ã®ã§ã€ä»Šã®æ“ä½œã‚‚å«ã¾ã‚Œã‚‹
                setTimeout(() => { // å°‘ã—é…å»¶ã•ã›ã¦æ¼”å‡º
                    const newStats = getClassStats();
                    const newDamage = newStats.totalClassPoints % bossHpPerLevel;
                    // å‰å›ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚ˆã‚Šä»Šå›ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒå°ã•ã„(0ã«ãªã£ãŸ) = å€’ã—ãŸ
                    // ãŸã ã—å˜ç´”ãªå‰°ä½™ã ã¨ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ™‚ã‚‚0ã«ãªã‚‹ã®ã§ã€ãƒ¬ãƒ™ãƒ«å¤‰åŒ–ã‚’è¦‹ã‚‹
                    // ç°¡æ˜“çš„ã«ï¼šHPãŒ0ã«ãªã£ãŸã‹
                    if (newDamage === 0 && newStats.totalClassPoints > 0) {
                        // è¨ä¼ï¼
                         showBonusEffect(`âš”ï¸ ãƒœã‚¹è¨ä¼ï¼ã€Œã‚¯ãƒ©ã‚¹ã®å®ˆè­·ç¥ã€ç§°å·ãƒãƒ£ãƒ³ã‚¹ï¼`);
                         // ã¨ã©ã‚ã‚’åˆºã—ãŸäººã«ç§°å·
                         const student = studentList.find(s => s.id === studentId);
                         if (student && !student.achievements.includes('guardian')) {
                             student.achievements.push('guardian');
                             saveStudentList();
                             showBonusEffect(`ğŸ‰ ${student.name}ãŒã¨ã©ã‚ã‚’åˆºã—ãŸï¼`);
                         }
                         
                         // å›³é‘‘ç™»éŒ²
                         const bossStage = Math.floor((newStats.totalClassPoints - 1) / bossHpPerLevel);
                         const bossIndex = bossStage % BOSS_CONFIG.bosses.length;
                         const boss = BOSS_CONFIG.bosses[bossIndex];
                         
                         const defeatedRecord = {
                             name: boss.name,
                             icon: boss.icon,
                             date: getDateKey(currentDate),
                             hitter: studentList.find(s => s.id === studentId)?.name || "åç„¡ã—"
                         };
                         classGameData.defeatedBosses.push(defeatedRecord);
                         saveGameData();
                    }
                }, 500);

            } else {
                playSound('wrong');
            }
            saveActivityData();
            renderCheckView();
        }

        // --- å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ ---
        function openPasswordModal() {
            document.getElementById('teacherPasswordInput').value = "";
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('teacherPasswordInput').focus();
        }
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            pendingTab = null;
        }
        function closePasswordModalOutside(event) {
            if (event.target.id === 'passwordModal') closePasswordModal();
        }
        function checkTeacherPassword() {
            const input = document.getElementById('teacherPasswordInput').value;
            if (input === teacherPassword) {
                isTeacherMode = true;
                document.getElementById('passwordModal').classList.add('hidden');
                updateTeacherModeUI();
                if (pendingTab === 'settings') {
                    switchTab('settings', true);
                    showBonusEffect("å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã—ãŸ");
                } else {
                    renderCheckView(); 
                    showBonusEffect("å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã—ãŸ");
                }
                pendingTab = null;
            } else {
                closePasswordModal();
                pendingTab = null;
                showWarningEffect("ã•ã‚ã£ã¦ã¯ã„ã‘ã¾ã›ã‚“ï¼");
            }
        }
        function exitTeacherMode() {
            isTeacherMode = false;
            updateTeacherModeUI();
            if (!document.getElementById('view-settings').classList.contains('hidden')) {
                switchTab('check');
            } else {
                renderCheckView();
            }
        }
        function updateTeacherModeUI() {
            const bar = document.getElementById('teacherModeBar');
            const nav = document.getElementById('mainNav');
            if (isTeacherMode) {
                bar.classList.remove('hidden');
                nav.style.marginTop = "40px"; 
            } else {
                bar.classList.add('hidden');
                nav.style.marginTop = "0";
            }
        }
        function toggleTeacherStamp(studentId) {
            if (!isTeacherMode) return;
            const dateKey = getDateKey(currentDate);
            if (!activityData[dateKey]) activityData[dateKey] = {};
            if (!activityData[dateKey][studentId]) activityData[dateKey][studentId] = { toban: false, shukudai: false, absent: false };
            const currentVal = !!activityData[dateKey][studentId].teacherStamp;
            activityData[dateKey][studentId].teacherStamp = !currentVal;
            if (!currentVal) playSound('correct');
            saveActivityData();
            renderCheckView();
        }

        // --- ãƒœãƒ¼ãƒŠã‚¹ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒªã‚»ãƒƒãƒˆ ---
        function checkBonusEffect(studentId) {
            const sortedDates = Object.keys(activityData).sort();
            let currentStreak = 0;
            let bonusTriggered = false;
            let streakCountDisplay = 0;

            sortedDates.forEach(dateKey => {
                const dayRecord = activityData[dateKey][studentId];
                if (!dayRecord) return;
                if (dayRecord.absent) {
                    // skip
                } else if (dayRecord.toban && dayRecord.shukudai) {
                    currentStreak++;
                    if (dateKey === getDateKey(currentDate)) {
                        streakCountDisplay = currentStreak;
                        if (currentStreak % 7 === 0) bonusTriggered = true;
                    }
                    if (currentStreak % 7 === 0) currentStreak = 0; 
                } else {
                    currentStreak = 0;
                }
            });

            if (bonusTriggered) {
                showBonusEffect("ğŸ‰ 1é€±é–“é€£ç¶šé”æˆï¼ +2pt GET! ğŸ‰");
                playSound('correct');
            } else if (streakCountDisplay > 0 && streakCountDisplay % 3 === 0) {
                showBonusEffect(`âœ¨ ${streakCountDisplay}æ—¥é€£ç¶šé”æˆï¼ âœ¨`);
            }
        }
        function showBonusEffect(text) {
            const container = document.getElementById('bonusContainer');
            const el = document.createElement('div');
            el.className = 'bonus-overlay';
            el.textContent = text;
            container.appendChild(el);
            setTimeout(() => { el.remove(); }, 2500);
        }
        function showWarningEffect(text) {
            const container = document.getElementById('bonusContainer');
            const el = document.createElement('div');
            el.className = 'warning-overlay';
            el.textContent = text;
            container.appendChild(el);
            setTimeout(() => { el.remove(); }, 3000);
        }
        function resetAllData() {
            if(confirm('ã€è­¦å‘Šã€‘å…¨ã¦ã®è¨˜éŒ²ã¨åç°¿ã‚’å®Œå…¨ã«æ¶ˆå»ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('classActivityData');
                localStorage.removeItem('classStudentList');
                localStorage.removeItem('classTeacherPassword');
                localStorage.removeItem('classBossHpPerLevel');
                localStorage.removeItem('classGameData');
                location.reload();
            }
        }

        // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ & ç§°å· ---
        function openCalendar(studentId) {
            currentCalendarStudentId = studentId;
            calendarYear = currentDate.getFullYear();
            calendarMonth = currentDate.getMonth();
            const student = studentList.find(s => s.id === studentId);
            document.getElementById('calStudentName').textContent = `${student ? student.name : ''}ã•ã‚“ã®è¨˜éŒ²`;
            
            // ç§°å·ãƒªã‚¹ãƒˆè¡¨ç¤º
            const achContainer = document.getElementById('achievementIcons');
            achContainer.innerHTML = '';
            const achList = document.getElementById('achievementList');
            
            if (student && student.achievements && student.achievements.length > 0) {
                achList.classList.remove('hidden');
                student.achievements.forEach(achId => {
                    const conf = ACHIEVEMENT_CONFIG.find(c => c.id === achId);
                    if (conf) {
                        const img = document.createElement('img');
                        img.src = conf.icon;
                        img.title = `${conf.name}: ${conf.desc}`;
                        img.className = "w-10 h-10 object-contain cursor-help hover:scale-125 transition-transform";
                        achContainer.appendChild(img);
                    }
                });
            } else {
                achList.classList.add('hidden');
            }

            document.getElementById('calendarModal').classList.remove('hidden');
            renderCalendar();
        }
        function closeCalendar() { document.getElementById('calendarModal').classList.add('hidden'); }
        function closeCalendarOutside(event) { if (event.target.id === 'calendarModal') closeCalendar(); }
        function changeCalendarMonth(offset) {
            calendarMonth += offset;
            if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
            else if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
            renderCalendar();
        }
        function renderCalendar() {
            const grid = document.getElementById('calGrid');
            grid.innerHTML = '';
            document.getElementById('calDateLabel').textContent = `${calendarYear}å¹´ ${calendarMonth + 1}æœˆ`;
            const firstDay = new Date(calendarYear, calendarMonth, 1);
            const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
            for (let i = 0; i < firstDay.getDay(); i++) grid.appendChild(document.createElement('div'));
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = "calendar-day bg-gray-50 hover:bg-gray-100 transition";
                const monthStr = String(calendarMonth + 1).padStart(2, '0');
                const dayStr = String(d).padStart(2, '0');
                const dateKey = `${calendarYear}-${monthStr}-${dayStr}`;
                const dayData = activityData[dateKey]?.[currentCalendarStudentId];
                let mark = "ãƒ»";
                let markClass = "text-gray-300";
                if (dayData) {
                    if (dayData.absent) { mark = "ä¼‘"; markClass = "text-gray-400 font-bold"; dayDiv.classList.add("bg-gray-200"); }
                    else if (dayData.toban && dayData.shukudai) { mark = `<img src="https://github.com/byakusen/hanamaru/blob/main/hanamaru2.png?raw=true" class="w-8 h-8 object-contain">`; markClass = ""; }
                    else if (dayData.toban) { mark = "å½“"; markClass = "text-indigo-600 font-bold"; }
                    else if (dayData.shukudai) { mark = "å®¿"; markClass = "text-amber-500 font-bold"; }
                }
                dayDiv.innerHTML = `<span class="absolute top-1 left-1 text-[10px] text-gray-400">${d}</span><span class="day-mark ${markClass}">${mark}</span>`;
                grid.appendChild(dayDiv);
            }
        }

        // --- ãƒœã‚¹å›³é‘‘ ---
        function openBossBook() {
            document.getElementById('bossBookModal').classList.remove('hidden');
            const grid = document.getElementById('bossBookGrid');
            grid.innerHTML = '';
            
            if (classGameData.defeatedBosses.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-400 py-10">ã¾ã è¨ä¼è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // æ–°ã—ã„é †ã«è¡¨ç¤º
            classGameData.defeatedBosses.slice().reverse().forEach(record => {
                const item = document.createElement('div');
                item.className = "flex items-center gap-4 bg-gray-50 p-3 rounded-lg border border-gray-200";
                item.innerHTML = `
                    <img src="${record.icon}" class="w-16 h-16 object-contain">
                    <div>
                        <div class="font-bold text-gray-800">${record.name}</div>
                        <div class="text-xs text-gray-500">${record.date} è¨ä¼</div>
                        <div class="text-xs text-indigo-600 font-bold mt-1">MVP: ${record.hitter}</div>
                    </div>
                `;
                grid.appendChild(item);
            });
        }
        function closeBossBook() { document.getElementById('bossBookModal').classList.add('hidden'); }
        function closeBossBookOutside(e) { if (e.target.id === 'bossBookModal') closeBossBook(); }

        // --- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
        function renderCheckView() {
            const dateKey = getDateKey(currentDate);
            document.getElementById('displayDate').textContent = `${currentDate.getFullYear()}/${String(currentDate.getMonth() + 1).padStart(2, '0')}/${String(currentDate.getDate()).padStart(2, '0')}`;
            renderBossBattle();
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            const activeStudents = studentList.filter(s => s.name && s.name.trim() !== "");
            const count = activeStudents.length;

            if (count === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-12 glass rounded-xl"><p class="text-xl font-bold text-gray-600 mb-2">ç”Ÿå¾’ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p><button onclick="switchTab('settings')" class="mt-4 bg-indigo-600 text-white px-6 py-2 rounded-full shadow-lg">è¨­å®šç”»é¢ã¸</button></div>`;
                return;
            }

            // å…¨å“¡ä¼‘ãƒœã‚¿ãƒ³çŠ¶æ…‹
            let isAllAbsent = activeStudents.length > 0 && activeStudents.every(s => activityData[dateKey]?.[s.id]?.absent === true);
            const btnAllAbsent = document.getElementById('btnAllAbsent');
            if (btnAllAbsent) {
                btnAllAbsent.className = isAllAbsent ? "ml-2 text-xs px-3 py-1 rounded-full bg-gray-600 text-white font-bold shadow-inner" : "ml-2 text-xs px-3 py-1 rounded-full border border-gray-400 text-gray-500 bg-white font-bold";
                btnAllAbsent.textContent = isAllAbsent ? "ä¼‘æ—¥è¨­å®šä¸­" : "ä¸€æ‹¬ä¼‘";
            }

            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
            let layoutClass = "";
            let gridClass = "grid gap-3 ";
            if (count <= 8) gridClass += "grid-cols-2 md:grid-cols-4";
            else if (count <= 20) { layoutClass = "layout-normal"; gridClass += "grid-cols-3 md:grid-cols-5"; }
            else if (count <= 32) { layoutClass = "layout-compact"; gridClass += "grid-cols-4 md:grid-cols-6"; }
            else { layoutClass = "layout-tiny"; gridClass += "grid-cols-4 md:grid-cols-8"; }
            container.className = `w-full max-w-[98%] mb-8 ${gridClass} ${layoutClass}`;

            activeStudents.forEach(student => {
                const dayRecord = activityData[dateKey]?.[student.id] || { toban: false, shukudai: false, absent: false };
                const isCompletedToday = dayRecord.toban && dayRecord.shukudai;
                const stats = getStudentStats(student);
                const card = document.createElement('div');
                card.className = "card glass rounded-xl flex flex-col items-center justify-between relative bg-white";
                if (dayRecord.absent) card.classList.add("absent");
                
                const roleLen = student.role ? student.role.length : 0;
                let roleFontSize = roleLen >= 7 ? "0.55rem" : (roleLen >= 5 ? "0.6rem" : "0.7rem");
                const roleBadge = student.role ? `<div class="card-role bg-indigo-50 text-indigo-800 px-1.5 py-0.5 rounded-full whitespace-nowrap font-bold border border-indigo-100 flex-shrink-0" style="font-size: ${roleFontSize}">${student.role}</div>` : ``;

                const nameLen = student.name.length;
                let nameFontSize = student.role ? (nameLen >= 7 ? "0.65rem" : (nameLen >= 5 ? "0.8rem" : (nameLen >= 4 ? "0.9rem" : "1rem"))) : (nameLen >= 9 ? "0.7rem" : (nameLen >= 7 ? "0.85rem" : (nameLen >= 5 ? "1rem" : "1rem")));

                let iconContent = stats.icon ? (stats.icon.startsWith('http') ? `<div class="w-full h-full" style="background-image: url('${stats.icon}'); background-size: contain; background-repeat: no-repeat; background-position: center;"></div>` : stats.icon) : `<div class="text-3xl text-gray-300">ğŸ”’</div>`;
                let stampOverlay = dayRecord.teacherStamp ? `<div class="stamp-overlay"></div>` : "";
                let teacherBtn = isTeacherMode ? `<button onclick="toggleTeacherStamp(${student.id})" class="absolute top-1 right-1 z-20 bg-white rounded-full p-1 shadow border border-red-200 hover:bg-red-50 text-xs">${dayRecord.teacherStamp ? 'æ¶ˆã™' : 'ğŸ’®'}</button>` : "";

                // ç§°å·ã‚¢ã‚¤ã‚³ãƒ³ (æœ€æ–°1ã¤ã ã‘è¡¨ç¤º)
                let achievementBadge = "";
                if (student.achievements && student.achievements.length > 0) {
                    const lastAchId = student.achievements[student.achievements.length - 1];
                    const conf = ACHIEVEMENT_CONFIG.find(c => c.id === lastAchId);
                    if (conf) {
                        achievementBadge = `<div class="absolute top-1 left-1 z-10 w-8 h-8 drop-shadow-md" title="æœ€æ–°ç§°å·: ${conf.name}"><img src="${conf.icon}" class="w-full h-full object-contain"></div>`;
                    }
                }

                card.innerHTML = `
                    ${teacherBtn}
                    ${achievementBadge}
                    <div class="flex flex-row items-center justify-center w-full mb-1 gap-1 overflow-hidden px-0.5 h-8">
                        <div class="card-name font-bold text-gray-800 leading-tight text-center whitespace-nowrap min-w-0" style="font-size: ${nameFontSize}">${student.name}</div>
                        ${roleBadge}
                    </div>
                    <div class="img-container card-icon-box rounded-2xl flex items-center justify-center mb-2 mt-1 ${stats.bg} ${isCompletedToday ? 'completed floating' : ''} cursor-pointer hover:opacity-80 transition-opacity relative" onclick="openCalendar(${student.id})">
                        ${iconContent}
                        ${stampOverlay}
                    </div>
                    <div class="flex gap-1 w-full mt-auto items-center">
                        <button onclick="toggleTask(${student.id}, 'toban')" class="card-btn flex-1 rounded-md font-bold shadow-sm btn-check ${dayRecord.toban ? 'bg-indigo-600 text-white ring-2 ring-indigo-300' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'}">å½“ç•ª</button>
                        <button onclick="toggleTask(${student.id}, 'shukudai')" class="card-btn flex-1 rounded-md font-bold shadow-sm btn-check ${dayRecord.shukudai ? 'bg-amber-500 text-white ring-2 ring-amber-300' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'}">å®¿é¡Œ</button>
                        <button onclick="toggleAbsent(${student.id})" class="card-btn w-8 rounded-md font-bold shadow-sm btn-check ${dayRecord.absent ? 'bg-gray-500 text-white ring-2 ring-gray-400' : 'bg-white text-gray-400 border border-gray-200 hover:bg-gray-50'}" title="æ¬ å¸­">ä¼‘</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- ãƒœã‚¹è¡¨ç¤º ---
        function renderBossBattle() {
            const stats = getClassStats();
            const totalPt = stats.totalClassPoints;
            const totalLv = stats.totalClassLevel;
            document.getElementById('displayClassLevel').textContent = totalLv;
            document.getElementById('nextClassLevelTarget').textContent = Math.ceil((totalLv + 1) / 100) * 100;

            const bossStage = Math.floor(totalPt / bossHpPerLevel); 
            const currentBossIndex = bossStage % BOSS_CONFIG.bosses.length;
            const currentBoss = BOSS_CONFIG.bosses[currentBossIndex];
            const currentHp = bossHpPerLevel - (totalPt % bossHpPerLevel);

            document.getElementById('bossName').textContent = `${currentBoss.name} (Lv.${bossStage + 1})`;
            document.getElementById('bossImage').src = currentBoss.icon;
            document.getElementById('bossHpBar').style.width = `${(currentHp / bossHpPerLevel) * 100}%`;
            document.getElementById('bossHpText').textContent = `${currentHp}/${bossHpPerLevel}`;
        }

        // --- åŠ¹æœéŸ³ & ç´™å¹é›ª (å¾©æ´») ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
                oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.4);
            } else {
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            }
        }

        function triggerConfetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#6366f1', '#f59e0b', '#22c55e']
            });
        }
    </script>
</body>
</html>